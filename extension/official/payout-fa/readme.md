# Tezpay Payout FA extension

This extension allows bakers to pay out rewards and bonuses in FA1.2 and FA2 tokens. It supports two base modes:

- **Bonus**: All generated rewards are added on top of the rewards generated by tezpay.
- **Replace**: Replaces rewards generated by tezpay with equivalents converted to FA tokens.

## Reward Calculation

Rewards are generated based on the exchange rate. The supported exchange rate kinds are:

- **fixed-amount**: Pays out a specified value, which is great for loyalty tokens.
- **fixed**: Pays out based on a specific exchange rate, ideal for share representation.
- **provider**: Fetches the exchange rate from a third-party provider. The only supported provider right now is `cmc`.

## Testing

For testing, you can use test contracts on ghostnet:

- [KT1Uf1UqfiXVjWFmKB8CzEuoaiM2EiSRfa3c](https://better-call.dev/ghostnet/KT1Uf1UqfiXVjWFmKB8CzEuoaiM2EiSRfa3c/interact/mint) - FA2
- [KT1XrNHYD98YWL6fzGSp6YiJJ8ohWySbqgXW](https://better-call.dev/ghostnet/KT1XrNHYD98YWL6fzGSp6YiJJ8ohWySbqgXW/interact/mint) - FA1.2

## Installation

1. Download the extension from the [releases page](https://github.com/tez-capital/tezpay/releases) based on your platform.
2. Place it into directory where you have tezpay installed.
3. Add the extension to your tezpay configuration
```yaml
...
	extensions: [
		{
			name: payout-fa
			command: "./tezpay_payout-fa" # or .exe based on your platform
			kind: stdio
			hooks: [
				after_bonds_distributed:rw
				check_balance:rw
			]
			configuration: {
				# see examples below
			}
		}
	]
...
```
1. Run pay `tezpay pay --cycle <cycle>`

## Examples

### Loyalty token
```yaml
		{
			name: payout-loyalty
			command: "./tezpay_payout-fa" # or .exe based on your platform
			kind: stdio
			hooks: [
				after_bonds_distributed:rw
				check_balance:rw
			]
			configuration: {
				exchange_rate_kind: fixed-amount
				reward_amount: 1
				reward_mode: bonus
				token: {
					id: 1
					contract: KT1Uf1UqfiXVjWFmKB8CzEuoaiM2EiSRfa3c
					kind: fa2
					alias: LOYALTY
					# or for FA1.2
					# contract: KT1XrNHYD98YWL6fzGSp6YiJJ8ohWySbqgXW
					# kind: fa1.2
				}
				log_file: log/payout-fa.log
			}
		}
```

### Fixed Exchange Rate
```yaml
		{
			name: payout-shares
			command: "./tezpay_payout-fa" # or .exe based on your platform
			kind: stdio
			hooks: [
				after_bonds_distributed:rw
				check_balance:rw
			]
			configuration: {
				exchange_rate_kind: fixed
				exchange_rate: 0.1
				exchange_fee: 0.01
				reward_mode: bonus
				token: {
					id: 1
					contract: KT1Uf1UqfiXVjWFmKB8CzEuoaiM2EiSRfa3c
					kind: fa2
					alias: USDT
					# or FA1.2
					# contract: KT1XrNHYD98YWL6fzGSp6YiJJ8ohWySbqgXW
					# kind: fa1.2
				}
				log_file: log/payout-fa.log
			}
		}
```

### Extra Bonus with CMC exchange rate
```yaml
		{
			name: payout-bonus
			command: "./tezpay_payout-fa" # or .exe based on your platform
			kind: stdio
			hooks: [
				after_bonds_distributed:rw
				check_balance:rw
			]
			configuration: {
				exchange_rate_kind: provider
				exchange_rate_provider: cmc
				# 10% as as bonus, so fee 90%
				exchange_fee: 0.9 
				exchange_rate_provider_configuration: {
					slug: bitcoin
					api_key: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
				}
				minimum_token_amount: 0.001 # 1000 satoshi
				reward_mode: bonus
				token: {
					id: 1
					contract: KT1Uf1UqfiXVjWFmKB8CzEuoaiM2EiSRfa3c
					kind: fa2
					alias: TzBTC
					# or FA1.2
					# contract: KT1XrNHYD98YWL6fzGSp6YiJJ8ohWySbqgXW
					# kind: fa1.2
					decimals: 6
				}
				log_file: log/payout-fa.log
			}
		}
```

### Token payout with CMC exchange rate
```yaml
{
    name: payout-tokens
    command: "./tezpay_payout-fa" # or .exe based on your platform
    kind: stdio
    hooks: [
        after_bonds_distributed:rw
        check_balance:rw
    ]
    configuration: {
        exchange_rate_kind: provider
        exchange_rate_provider: cmc
		# exchange fee baker charges
        exchange_fee: 0.01 
        exchange_rate_provider_configuration: {
            slug: bitcoin
            api_key: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
        }
        minimum_token_amount: 0.001 # 1000 satoshi
        reward_mode: replace
        token: {
            id: 1
            contract: KT1Uf1UqfiXVjWFmKB8CzEuoaiM2EiSRfa3c
            kind: fa2
            alias: TzBTC
			# or FA1.2
            # contract: KT1XrNHYD98YWL6fzGSp6YiJJ8ohWySbqgXW
            # kind: fa1.2
            decimals: 6
        }
        log_file: log/payout-fa.log
    }
}
```